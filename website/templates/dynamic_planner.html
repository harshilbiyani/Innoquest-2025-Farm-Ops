<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='agriculture-chatbot-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Dynamic Crop Growth Planner - FarmOps</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      html, body {
        height: 100%;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        overflow-x: hidden;
      }

      body {
        background: url('{{ url_for('static', filename='images/landing-bg.jpg') }}') no-repeat center center fixed;
        background-size: cover;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #e8ff5a;
        min-height: 100vh;
        width: 100vw;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 20px 0;
      }

      /* Main container with glassmorphism */
      .planner-container {
        max-width: 1400px;
        width: 95vw;
        margin: 20px auto;
        padding: 40px 32px 50px 32px;
        border-radius: 32px;
        background: rgba(255,255,255,0.13);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
        backdrop-filter: blur(16px) saturate(140%);
        -webkit-backdrop-filter: blur(16px) saturate(140%);
        border: 1.5px solid rgba(232,255,90,0.18);
        position: relative;
        z-index: 1;
        min-height: fit-content;
        margin-bottom: 80px;
        overflow: visible;
      }

      /* Header styling */
      .planner-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .planner-title {
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 2.8rem;
        font-weight: 900;
        text-align: center;
        margin: 1.5rem 0 1.6rem 0;
        letter-spacing: 2.2px;
        line-height: 1.18;
        color: #1c361b;
        text-shadow: 0 5px 18px #a5ff4e55, 0px 1px 1px #3e892b17;
        background: linear-gradient(92deg, #e8ff5a 18%, #43a047 48%, #5aedc7 80%);
        background-size: 400% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: shimmerSmooth 3.2s linear infinite alternate;
      }

      @keyframes shimmerSmooth {
        0%   {background-position: 0% 50%;}
        100% {background-position: 100% 50%;}
      }

      .planner-subtitle {
        font-size: 1.2rem;
        color: rgba(232, 255, 90, 0.9);
        margin-bottom: 30px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      /* Input form styling */
      .input-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(232, 255, 90, 0.2);
      }

      .input-section h3 {
        color: #e8ff5a;
        font-size: 1.5rem;
        margin-bottom: 20px;
        text-align: center;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .simple-form-grid {
        display: flex;
        flex-direction: column;
        gap: 25px;
        margin-bottom: 30px;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
      }

      .instruction-text {
        color: rgba(232, 255, 90, 0.9);
        font-size: 1.1rem;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 500;
      }

      .form-group.large {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(232, 255, 90, 0.2);
      }

      .help-text {
        color: rgba(232, 255, 90, 0.7);
        font-size: 0.9rem;
        margin-top: 8px;
        font-style: italic;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        color: #e8ff5a;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1rem;
      }

      .form-group select, .form-group input {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(232, 255, 90, 0.3);
        border-radius: 12px;
        padding: 12px 15px;
        font-size: 1rem;
        color: #e8ff5a;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-weight: 600;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        outline: none;
      }

      .form-group select:focus, .form-group input:focus {
        border-color: #e8ff5a;
        box-shadow: 0 0 15px rgba(232, 255, 90, 0.3);
        background: rgba(255, 255, 255, 0.15);
      }

      .form-group select option {
        background: rgba(26, 26, 26, 0.95);
        color: #e8ff5a;
        padding: 10px;
        font-weight: 600;
      }

      .crop-selector-section {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }

      .crop-selector {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(232, 255, 90, 0.3);
        border-radius: 25px;
        padding: 12px 20px;
        font-size: 1.1rem;
        color: #e8ff5a;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-weight: 600;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        min-width: 250px;
        text-align: center;
        outline: none;
      }

      .crop-selector:focus {
        border-color: #e8ff5a;
        box-shadow: 0 0 15px rgba(232, 255, 90, 0.3);
        background: rgba(255, 255, 255, 0.15);
      }

      .generate-btn {
        background: linear-gradient(135deg, #43a047, #66bb6a);
        border: none;
        border-radius: 15px;
        padding: 15px 30px;
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
        display: block;
        margin: 20px auto;
        min-width: 200px;
      }

      .generate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(67, 160, 71, 0.4);
        background: linear-gradient(135deg, #388e3c, #4caf50);
      }

      .generate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Results section */
      .results-section {
        display: none;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(232, 255, 90, 0.2);
      }

      .soil-analysis {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .soil-analysis h4 {
        color: #e8ff5a;
        margin-bottom: 15px;
      }

      .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .analysis-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #43a047;
      }

      .analysis-item strong {
        color: #e8ff5a;
      }

      .suitability-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        margin: 10px 0;
      }

      .highly-suitable { background: #4caf50; color: white; }
      .moderately-suitable { background: #ff9800; color: white; }
      .not-suitable { background: #f44336; color: white; }

      /* Enhanced Chart container with glassmorphism */
      .chart-container {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
        border-radius: 25px;
        padding: 30px;
        margin-top: 25px;
        box-shadow: 
          0 8px 32px rgba(31, 38, 135, 0.37),
          inset 0 1px 0 rgba(255, 255, 255, 0.3),
          0 1px 0 rgba(255, 255, 255, 0.3);
        border: 1.5px solid rgba(232, 255, 90, 0.18);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        overflow: hidden;
        position: relative;
      }

      .chart-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(232, 255, 90, 0.6), transparent);
        z-index: 1;
      }

      .chart-header {
        text-align: center;
        margin-bottom: 25px;
        position: relative;
        z-index: 2;
      }

      .chart-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1c361b;
        text-shadow: 0 2px 4px rgba(232, 255, 90, 0.3);
        background: linear-gradient(135deg, #e8ff5a, #43a047);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
      }

      .chart-subtitle {
        font-size: 1rem;
        color: rgba(28, 54, 27, 0.8);
        font-weight: 500;
      }

      #chart_div {
        width: 100%;
        min-height: 500px;
        margin: 0;
        overflow-x: auto;
        overflow-y: visible;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 
          0 8px 25px rgba(67, 160, 71, 0.15),
          0 2px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(67, 160, 71, 0.2);
        position: relative;
        transition: all 0.3s ease;
        animation: chartFadeIn 0.6s ease-out;
      }

      #chart_div:hover {
        transform: translateY(-3px);
        box-shadow: 
          0 12px 35px rgba(67, 160, 71, 0.2),
          0 4px 15px rgba(0, 0, 0, 0.15);
      }

      @keyframes chartFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Chart Header Styling */
      .chart-header {
        text-align: center;
        margin-bottom: 20px;
        color: #1c361b;
      }

      .chart-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #1c361b, #43a047);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .chart-subtitle {
        font-size: 14px;
        opacity: 0.8;
        font-weight: 500;
      }

      /* Custom Gantt chart styling */
      .google-visualization-gantt-bar-fill {
        opacity: 0.8 !important;
      }

      /* Enhanced timeline legend */
      .timeline-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(232, 255, 90, 0.2);
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 500;
        color: #1c361b;
        padding: 8px 12px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(232, 255, 90, 0.15);
        transition: all 0.3s ease;
      }

      .legend-item:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.05);
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .legend-color.critical { 
        background: linear-gradient(135deg, #e53e3e, #c62828);
      }
      .legend-color.high { 
        background: linear-gradient(135deg, #ff9800, #f57c00);
      }
      .legend-color.normal { 
        background: linear-gradient(135deg, #43a047, #2e7d32);
      }
      .legend-color.treatment { 
        background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      }

      /* Navigation buttons */
      .nav-link, .back-button {
        position: absolute;
        top: 25px;
        z-index: 10;
        background: rgba(247, 251, 246, 0.81);
        border-radius: 12px;
        box-shadow: 0 4px 22px rgba(60, 80, 70, 0.16);
        padding: 12px 20px;
        color: #388e3c;
        text-decoration: none;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.5px;
        border: 1.3px solid rgba(232, 255, 90, 0.11);
        transition: transform .36s, box-shadow .36s, background .36s, color .36s, border-color .36s;
        backdrop-filter: blur(11px);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .nav-link {
        left: 25px;
      }

      .back-button {
        right: 25px;
      }

      .nav-link:hover, .back-button:hover {
        transform: scale(1.04) rotate(-0.5deg);
        box-shadow: 0 12px 30px rgba(193,255,58,0.12), 0 4px 14px rgba(56,142,60,0.12);
        background: rgba(238,255,210, 0.9);
        border-color: #e8ff5a;
        color: #1c361b;
        text-shadow: 0 1px 3px rgba(67, 160, 71, 0.3);
      }

      .nav-link::before {
        content: 'üè†';
        margin-right: 8px;
        font-size: 1.1rem;
        transition: transform .3s;
      }

      .back-button::before {
        content: '‚Üê';
        margin-right: 8px;
        font-size: 1.1rem;
        transition: transform .3s;
      }

      .nav-link:hover::before, .back-button:hover::before {
        transform: scale(1.1);
      }

      /* Soil Advice Styling */
      .soil-advice-card {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid rgba(232, 255, 90, 0.3);
        backdrop-filter: blur(10px);
      }

      .soil-type-info h5 {
        color: #e8ff5a;
        font-size: 1.3rem;
        margin-bottom: 10px;
      }

      .soil-description {
        color: rgba(232, 255, 90, 0.9);
        font-size: 1rem;
        margin-bottom: 20px;
        font-style: italic;
      }

      .advice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .advantages-section, .challenges-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(232, 255, 90, 0.2);
      }

      .advantages-section h6 {
        color: #43a047;
        font-size: 1.1rem;
        margin-bottom: 15px;
      }

      .challenges-section h6 {
        color: #ff9800;
        font-size: 1.1rem;
        margin-bottom: 15px;
      }

      .recommendations-section {
        background: rgba(67, 160, 71, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(67, 160, 71, 0.3);
        margin-top: 20px;
      }

      .recommendations-section h6 {
        color: #e8ff5a;
        font-size: 1.2rem;
        margin-bottom: 15px;
      }

      .advantages-section ul,
      .challenges-section ul,
      .recommendations-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .advantages-section li::before {
        content: '‚úÖ ';
        margin-right: 8px;
      }

      .challenges-section li::before {
        content: '‚ö†Ô∏è ';
        margin-right: 8px;
      }

      .recommendations-list li::before {
        content: 'üí° ';
        margin-right: 8px;
      }

      .advantages-section li,
      .challenges-section li,
      .recommendations-list li {
        color: rgba(232, 255, 90, 0.9);
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(232, 255, 90, 0.1);
        font-size: 0.95rem;
        line-height: 1.4;
      }

      /* Responsive enhancements */
      @media (max-width: 768px) {
        #chart_div {
          padding: 15px;
          margin: 10px 0;
          min-height: 400px;
        }
        
        .chart-title {
          font-size: 20px;
        }
        
        .timeline-legend {
          gap: 10px;
          padding: 10px;
        }
        
        .legend-item {
          font-size: 12px;
          padding: 6px 10px;
        }

        .nav-link, .back-button {
          padding: 8px 15px;
          font-size: 0.9rem;
        }

        .advice-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .soil-advice-card {
          padding: 20px;
        }
      }

      /* Loading animation */
      .loading {
        display: none;
        text-align: center;
        color: #e8ff5a;
        font-size: 1.1rem;
        margin: 20px 0;
      }

      .loading::after {
        content: '';
        animation: dots 1.5s steps(5, end) infinite;
      }

      @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60% { content: '...'; }
        80%, 100% { content: ''; }
      }

      /* Responsive design */
      @media (max-width: 1200px) {
        .planner-container {
          width: 98vw;
          padding: 30px 20px 40px 20px;
        }
        
        .planner-title {
          font-size: 2.4rem;
        }
      }

      @media (max-width: 768px) {
        .planner-container {
          padding: 20px 15px 30px 15px;
          margin: 10px;
          width: calc(100vw - 20px);
        }
        
        .planner-title {
          font-size: 2rem;
          margin: 1rem 0;
        }
        
        .form-grid {
          grid-template-columns: 1fr;
        }
        
        .nav-link, .back-button {
          padding: 10px 16px;
          font-size: 0.9rem;
          top: 15px;
        }
        
        .nav-link {
          left: 15px;
        }
        
        .back-button {
          right: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="planner-container">
      <a href="{{ url_for('main_dashboard') }}" class="nav-link">
        Home
      </a>
      
      <a href="{{ url_for('index') }}" class="back-button">
        Back to Crop Suggestions
      </a>
      
      <div class="planner-header">
        <h1 class="planner-title">Dynamic Crop Growth Planner</h1>
        <p class="planner-subtitle">Generate personalized crop timelines based on your soil conditions</p>
      </div>

      <!-- Soil Analysis Status Section -->
      {% if session.get('has_soil_analysis') and session.get('soil_data') %}
      <div class="soil-analysis-status" style="margin-bottom: 30px; padding: 20px; border-radius: 16px; background: rgba(76, 175, 80, 0.15); border: 1px solid rgba(76, 175, 80, 0.3);">
        {% if session.get('data_source') == 'location_based' %}
        <h3 style="color: #4CAF50; margin-bottom: 10px;">üìç Location-Based Soil Data Loaded</h3>
        <p style="color: #e8ff5a; margin-bottom: 15px;">
          We extracted detailed soil data for {{ session.soil_data.location if session.soil_data.location else 'your selected location' }}. 
          Your Gantt chart will include location-specific adjustments based on:
        </p>
        {% else %}
        <h3 style="color: #4CAF50; margin-bottom: 10px;">üî¨ Advanced Soil Analysis Detected</h3>
        <p style="color: #e8ff5a; margin-bottom: 15px;">
          We found your detailed soil analysis from {{ session.soil_data.timestamp[:19] if session.soil_data.timestamp else 'recently' }}. 
          Your Gantt chart will include advanced adjustments based on:
        </p>
        {% endif %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em;">
          <div>üìä pH Level: {{ session.soil_data.ph if session.soil_data.ph else 'Analyzed' }}</div>
          <div>üß™ Nutrient Status: {{ session.soil_data.nitrogen if session.soil_data.nitrogen else 'Measured' }}</div>
          <div>üå°Ô∏è Temperature Profile: {{ session.soil_data.temp_summer if session.soil_data.temp_summer else 'Available' }}</div>
          <div>üíß Rainfall Data: {{ session.soil_data.rainfall if session.soil_data.rainfall else 'Complete' }}</div>
        </div>
        <small style="color: #bbb; display: block; margin-top: 10px;">
          {% if session.get('data_source') == 'location_based' %}
            This creates a location-optimized timeline with region-specific treatments and adjustments.
          {% else %}
            This creates a more precise timeline with soil-specific treatments and adjustments.
          {% endif %}
        </small>
      </div>
      {% endif %}

      <!-- Simple Farmer-Friendly Input Section -->
      <div class="input-section" {% if selected_crop and session.get('has_soil_analysis') %}style="display: none;"{% endif %}>
        <h3>üå± {{ 'Advanced' if session.get('has_soil_analysis') else 'Simple' }} Farm Planning</h3>
        <p class="instruction-text">
          {% if session.get('has_soil_analysis') %}
            Your soil analysis will enhance this timeline with precise adjustments!
          {% else %}
            Just tell us about your soil and crop - we'll handle the rest!
          {% endif %}
        </p>
        <form id="plannerForm">
          <div class="simple-form-grid">
            <div class="form-group large">
              <label for="soil_type">üèûÔ∏è What type of soil do you have?</label>
              <select id="soil_type" name="soil_type" required>
                <option value="">Choose your soil type</option>
                <option value="clayey_moist">üü§ Clay Soil (holds water well)</option>
                <option value="clayey_dry">üü´ Clay Soil (gets hard when dry)</option>
                <option value="sandy_moist">üü® Sandy Soil (drains water quickly)</option>
                <option value="sandy_dry">üü° Sandy Soil (very dry)</option>
                <option value="loamy_moist">üü¢ Loamy Soil (best for farming - moist)</option>
                <option value="loamy_dry">üå± Loamy Soil (good for farming - dry)</option>
                <option value="black_cotton">‚ö´ Black Cotton Soil (rich and fertile)</option>
                <option value="red_soil">üî¥ Red Soil (common in many areas)</option>
                <option value="alluvial">üü† River/Alluvial Soil (near rivers)</option>
                <option value="laterite">üü£ Laterite Soil (red-orange clay)</option>
              </select>
              <small class="help-text">Not sure? Ask your local agricultural officer or choose the closest match</small>
            </div>

            <div class="form-group large">
              <label for="crop_name">üåæ Which crop do you want to grow?</label>
              <select id="crop_name" name="crop_name" required>
                <option value="">Select your crop</option>
                <option value="sugarcane">üåæ Sugarcane</option>
                <option value="cotton">üå∏ Cotton</option>
                <option value="soyabean">üå± Soyabean</option>
                <option value="rice">üåæ Rice</option>
                <option value="jowar">üåæ Jowar</option>
                <option value="tur">ü´ò Tur (Pigeon Pea)</option>
                <option value="wheat">üåæ Wheat</option>
                <option value="groundnut">ü•ú Groundnut</option>
                <option value="onion">üßÖ Onion</option>
                <option value="tomato">üçÖ Tomato</option>
                <option value="potato">ü•î Potato</option>
                <option value="garlic">üßÑ Garlic</option>
              </select>
              <small class="help-text">Choose the crop you want to plant this season</small>
            </div>
          </div>



          <button type="submit" class="generate-btn" id="generateBtn">
            üåæ Generate My Farm Timeline
          </button>
        </form>

        <div class="loading" id="loadingDiv">
          üå± Creating your personalized farm timeline...
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-section" id="resultsSection">
        <div class="soil-analysis" id="soilAnalysis">
          <!-- Soil analysis results will be inserted here -->
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title" id="chartTitle">Dynamic Crop Timeline</h3>
            <p class="chart-subtitle" id="chartSubtitle">Personalized growth schedule based on your soil conditions</p>
          </div>
          <div id="chart_div"></div>
          <div class="timeline-legend" id="timelineLegend">
            <div class="legend-item">
              <div class="legend-color critical"></div>
              <span>Critical Phases</span>
            </div>
            <div class="legend-item">
              <div class="legend-color high"></div>
              <span>High Priority</span>
            </div>
            <div class="legend-item">
              <div class="legend-color medium"></div>
              <span>Medium Priority</span>
            </div>
            <div class="legend-item">
              <div class="legend-color treatment"></div>
              <span>Soil Treatment</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chatbot Widget (initially hidden) -->
    <div class="agri-chatbot-widget" id="chatbot" style="display: none;">
        <div class="chatbot-header">
            <div class="bot-icon">
              <img src="{{ url_for('static', filename='images/icon.png') }}" alt="Chatbot Icon">
            </div>
            <div class="bot-info">
                <h3>AgriBot AI</h3>
                <p>Your farming assistant</p>
            </div>
            <div class="status-indicator"></div>
            <button class="minimize-btn" onclick="toggleChatbot()">‚àí</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="quick-suggestions">
            <button class="suggestion-btn">Crop rotation</button>
            <button class="suggestion-btn">Pest control</button>
            <button class="suggestion-btn">Weather forecast</button>
        </div>
        <div class="chat-input-area">
            <div class="input-container">
                <input type="text" class="chat-input" placeholder="Ask about farming, crops, weather..." id="messageInput">
                <button class="send-button" onclick="sendMessage()"></button>
            </div>
        </div>
    </div>

    <!-- Toggle Button (initially visible) -->
    <button class="chatbot-toggle" id="chatbotToggle" onclick="toggleChatbot()" style="display: flex;">
      <img src="{{ url_for('static', filename='images/icon.png') }}" alt="Chatbot">
    </button>

    <script src="{{ url_for('static', filename='chatbot.js') }}"></script>
    
    <script type="text/javascript">
      // Load Google Charts and set callback
      google.charts.load("current", { packages: ["gantt"] });
      google.charts.setOnLoadCallback(function() {
        console.log('Google Charts loaded successfully');
      });
      
      let currentChart = null;

      document.addEventListener('DOMContentLoaded', function() {
        // Pre-select crop if provided via URL parameter
        const selectedCrop = '{{ selected_crop }}';
        if (selectedCrop) {
          const cropSelect = document.getElementById('crop_name');
          const normalizedCrop = selectedCrop.replace(/_/g, '').toLowerCase();
          
          // Find matching option (handle name variations)
          for (let option of cropSelect.options) {
            const optionValue = option.value.toLowerCase();
            if (optionValue === normalizedCrop || 
                optionValue.includes(normalizedCrop) ||
                normalizedCrop.includes(optionValue)) {
              option.selected = true;
              break;
            }
          }
        }
        
        // Auto-submit for direct crop selection
        {% if selected_crop and session.get('has_soil_analysis') %}
        // Auto-generate timeline for pre-selected crop
        setTimeout(function() {
          generateDynamicPlan();
        }, 500);
        {% endif %}

        document.getElementById('plannerForm').addEventListener('submit', function(e) {
          e.preventDefault();
          generateDynamicPlan();
        });
      });

      async function generateDynamicPlan() {
        const loadingDiv = document.getElementById('loadingDiv');
        const generateBtn = document.getElementById('generateBtn');
        const resultsSection = document.getElementById('resultsSection');

        // Get simple form data
        const soilType = document.getElementById('soil_type').value;
        const cropName = document.getElementById('crop_name').value;

        if (!soilType || !cropName) {
          alert('üå± Please select both soil type and crop');
          return;
        }

        // Show loading
        loadingDiv.style.display = 'block';
        generateBtn.disabled = true;
        generateBtn.textContent = 'Creating Your Timeline...';
        resultsSection.style.display = 'none';

        try {
          const response = await fetch('/generate-dynamic-plan', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              crop_name: cropName,
              soil_type: soilType
            })
          });

          const result = await response.json();

          if (result.success) {
            console.log('Received result:', result);
            displaySoilAdvice(result.soil_advice, result.soil_type, result.crop_name);
            
            // Wait for Google Charts to be ready
            google.charts.setOnLoadCallback(function() {
              drawGanttChart(result.timeline, cropName);
            });
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
          } else {
            console.error('Error from server:', result.error);
            alert('‚ùå Error generating timeline: ' + result.error);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('‚ùå Failed to generate timeline. Please check your connection and try again.');
        } finally {
          // Hide loading
          loadingDiv.style.display = 'none';
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate My Farm Timeline';
        }
      }

      function displaySoilAdvice(advice, soilType, cropName) {
        const soilAnalysisDiv = document.getElementById('soilAnalysis');
        
        const soilTypeNames = {
          'clayey_moist': 'Clay Soil (Moist)',
          'clayey_dry': 'Clay Soil (Dry)', 
          'sandy_moist': 'Sandy Soil (Moist)',
          'sandy_dry': 'Sandy Soil (Dry)',
          'loamy_moist': 'Loamy Soil (Moist)',
          'loamy_dry': 'Loamy Soil (Dry)',
          'black_cotton': 'Black Cotton Soil',
          'red_soil': 'Red Soil',
          'alluvial': 'Alluvial Soil',
          'laterite': 'Laterite Soil'
        };

        let analysisHTML = `
          <div class="soil-advice-card">
            <h4>üå± Your Soil Analysis for ${cropName.charAt(0).toUpperCase() + cropName.slice(1)}</h4>
            
            <div class="soil-type-info">
              <h5>üèûÔ∏è Soil Type: ${soilTypeNames[soilType] || soilType}</h5>
              <p class="soil-description">${advice.description}</p>
            </div>

            <div class="advice-grid">
              <div class="advantages-section">
                <h6>‚úÖ Advantages</h6>
                <ul>
                  ${advice.advantages.map(adv => `<li>${adv}</li>`).join('')}
                </ul>
              </div>
              
              <div class="challenges-section">
                <h6>‚ö†Ô∏è Challenges</h6>
                <ul>
                  ${advice.challenges.map(challenge => `<li>${challenge}</li>`).join('')}
                </ul>
              </div>
            </div>

            <div class="recommendations-section">
              <h6>üí° Recommendations for Success</h6>
              <ul class="recommendations-list">
                ${advice.recommendations.map(rec => `<li>${rec}</li>`).join('')}
              </ul>
            </div>
          </div>`;

        soilAnalysisDiv.innerHTML = analysisHTML;
      }

      function drawGanttChart(timeline, cropName) {
        console.log('Drawing chart for:', cropName, 'with timeline:', timeline);
        
        // Update chart title
        const titleElement = document.getElementById('chartTitle');
        const subtitleElement = document.getElementById('chartSubtitle');
        
        if (titleElement) {
          titleElement.textContent = `${cropName.charAt(0).toUpperCase() + cropName.slice(1)} Growth Timeline`;
        }
        if (subtitleElement) {
          subtitleElement.textContent = `${timeline.length} phases planned`;
        }

        const data = new google.visualization.DataTable();
        data.addColumn("string", "Task ID");
        data.addColumn("string", "Task Name");
        data.addColumn("string", "Resource");
        data.addColumn("date", "Start Date");
        data.addColumn("date", "End Date");
        data.addColumn("number", "Duration");
        data.addColumn("number", "Percent Complete");
        data.addColumn("string", "Dependencies");

        const rows = timeline.map(task => {
          const startDate = new Date(task.start_date);
          const endDate = new Date(task.end_date);
          
          return [
            task.id,
            task.task_name,
            task.category,
            startDate,
            endDate,
            task.duration,
            0,
            task.dependencies
          ];
        });

        data.addRows(rows);

        // Clean chart styling
        const options = {
          height: 500,
          backgroundColor: '#ffffff',
          gantt: {
            trackHeight: 40,
            barHeight: 30,
            labelStyle: {
              fontName: "Segoe UI",
              fontSize: 12,
              color: "#333333"
            }
          }
        };

        try {
          const chartElement = document.getElementById("chart_div");
          if (!chartElement) {
            console.error('Chart div not found');
            return;
          }
          
          const chart = new google.visualization.Gantt(chartElement);
          chart.draw(data, options);
          currentChart = chart;
          console.log('Chart drawn successfully with', timeline.length, 'tasks');
        } catch (error) {
          console.error('Error drawing chart:', error);
          const chartDiv = document.getElementById("chart_div");
          if (chartDiv) {
            chartDiv.innerHTML = '<div style="text-align: center; color: #e53e3e; padding: 50px; background: white; border-radius: 10px;"><h3>‚ö†Ô∏è Chart Loading Error</h3><p>Unable to display timeline. Please refresh and try again.</p></div>';
          }
        }
      }

      function calculateTotalDays(timeline) {
        if (!timeline || timeline.length === 0) return 0;
        const startDate = new Date(timeline[0].start_date);
        const endDate = new Date(timeline[timeline.length - 1].end_date);
        return Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      }



      // Initialize Google Charts when page loads
      google.charts.setOnLoadCallback(() => {
        console.log('Google Charts loaded and ready');
      });
    </script>
  </body>
</html>